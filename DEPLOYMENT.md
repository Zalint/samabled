# üöÄ Guide de D√©ploiement - SamaBled sur Render

Ce guide vous explique comment d√©ployer l'application **SamaBled** (correction orthographique et grammaticale) sur **Render** avec une base de donn√©es **PostgreSQL**.

## üìã Pr√©requis

- Compte [Render](https://render.com) (gratuit)
- Compte [GitHub](https://github.com) avec votre repository
- Cl√© API OpenAI (pour les corrections)

## üóÑÔ∏è 1. Configuration de la Base de Donn√©es PostgreSQL

### √âtape 1.1 : Cr√©er la base de donn√©es
1. Connectez-vous √† [Render Dashboard](https://dashboard.render.com)
2. Cliquez sur **"New +"** ‚Üí **"PostgreSQL"**
3. Configurez votre base de donn√©es :
   - **Name** : `samabled-db`
   - **Database** : `samabled`
   - **User** : `samabled_user`
   - **Region** : Choisissez la r√©gion la plus proche
   - **PostgreSQL Version** : 15 (recommand√©)
   - **Plan** : Free (pour commencer)

4. Cliquez sur **"Create Database"**

### √âtape 1.2 : R√©cup√©rer les informations de connexion
Une fois la base cr√©√©e, notez les informations suivantes dans l'onglet **"Connect"** :
- **Internal Database URL** (pour l'application)
- **External Database URL** (pour les connexions externes)
- **Host**, **Port**, **Database**, **Username**, **Password**

### √âtape 1.3 : Initialiser la base de donn√©es
1. Utilisez l'**External Database URL** pour vous connecter via un client PostgreSQL
2. Ex√©cutez le script d'initialisation :

```sql
-- Cr√©er la table des utilisateurs
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Cr√©er la table des corrections
CREATE TABLE corrections (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    original_text TEXT NOT NULL,
    corrected_text TEXT NOT NULL,
    error_message TEXT,
    position_start INTEGER NOT NULL DEFAULT 0,
    position_end INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Cr√©er des index pour optimiser les performances
CREATE INDEX idx_corrections_user_id ON corrections(user_id);
CREATE INDEX idx_corrections_created_at ON corrections(created_at);
CREATE INDEX idx_users_email ON users(email);

-- Fonction pour mettre √† jour updated_at automatiquement
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Trigger pour la table users
CREATE TRIGGER update_users_updated_at 
    BEFORE UPDATE ON users 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();
```

## üåê 2. D√©ploiement de l'Application Web

### √âtape 2.1 : Pr√©parer le repository
1. Assurez-vous que votre code est pouss√© sur GitHub
2. V√©rifiez que vous avez les fichiers suivants :
   - `package.json` avec les scripts de d√©marrage
   - `server.js` (point d'entr√©e)
   - Variables d'environnement configur√©es

### √âtape 2.2 : Cr√©er le service web sur Render
1. Dans Render Dashboard, cliquez sur **"New +"** ‚Üí **"Web Service"**
2. Connectez votre repository GitHub :
   - **Repository** : `https://github.com/Zalint/samabled.git`
   - **Branch** : `main`

3. Configurez le service :
   - **Name** : `samabled-app`
   - **Region** : M√™me r√©gion que votre base de donn√©es
   - **Branch** : `main`
   - **Root Directory** : (laisser vide)
   - **Runtime** : `Node`
   - **Build Command** : `npm install`
   - **Start Command** : `npm start`
   - **Plan** : Free (pour commencer)

### √âtape 2.3 : Configurer les variables d'environnement
Dans l'onglet **"Environment"** de votre service web, ajoutez :

```bash
# Base de donn√©es (utilisez l'Internal Database URL de votre PostgreSQL)
DATABASE_URL=postgresql://username:password@host:port/database

# S√©curit√©
JWT_SECRET=votre_jwt_secret_tres_securise_ici
PORT=10000

# API OpenAI (optionnel, pour les corrections avanc√©es)
OPENAI_API_KEY=votre_cle_api_openai

# Configuration Node.js
NODE_ENV=production
```

**‚ö†Ô∏è Important** : 
- Utilisez l'**Internal Database URL** de votre PostgreSQL Render
- G√©n√©rez un JWT_SECRET s√©curis√© (32+ caract√®res al√©atoires)
- Le PORT doit √™tre 10000 pour Render

### √âtape 2.4 : D√©ployer
1. Cliquez sur **"Create Web Service"**
2. Render va automatiquement :
   - Cloner votre repository
   - Installer les d√©pendances (`npm install`)
   - D√©marrer l'application (`npm start`)

## üìù 3. Configuration du package.json

Assurez-vous que votre `package.json` contient :

```json
{
  "name": "samabled",
  "version": "1.0.0",
  "description": "Application de correction orthographique et grammaticale",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "engines": {
    "node": ">=18.0.0",
    "npm": ">=8.0.0"
  },
  "dependencies": {
    "express": "^4.18.2",
    "pg": "^8.11.3",
    "bcryptjs": "^2.4.3",
    "jsonwebtoken": "^9.0.2",
    "cors": "^2.8.5",
    "helmet": "^7.0.0",
    "express-rate-limit": "^6.10.0"
  },
  "devDependencies": {
    "nodemon": "^3.0.1"
  }
}
```

## üîß 4. Configuration du serveur (server.js)

V√©rifiez que votre `server.js` utilise les variables d'environnement :

```javascript
const express = require('express');
const path = require('path');
const cors = require('cors');
const helmet = require('helmet');
const rateLimit = require('express-rate-limit');

const app = express();
const PORT = process.env.PORT || 3000;

// Configuration pour la production
if (process.env.NODE_ENV === 'production') {
    app.use(helmet());
    app.use(rateLimit({
        windowMs: 15 * 60 * 1000, // 15 minutes
        max: 100 // limite chaque IP √† 100 requ√™tes par windowMs
    }));
}

// Middleware
app.use(cors());
app.use(express.json({ limit: '10mb' }));
app.use(express.static(path.join(__dirname, 'public')));

// Routes API
app.use('/api', require('./routes/api'));

// Route pour servir l'application
app.get('*', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

app.listen(PORT, '0.0.0.0', () => {
    console.log(`üöÄ Serveur d√©marr√© sur le port ${PORT}`);
    console.log(`üìä Environnement: ${process.env.NODE_ENV || 'development'}`);
});
```

## üîê 5. Configuration de la Base de Donn√©es (config/database.js)

```javascript
const { Pool } = require('pg');

// Configuration pour Render (utilise DATABASE_URL)
const pool = new Pool({
    connectionString: process.env.DATABASE_URL,
    ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false
});

// Test de connexion
pool.on('connect', () => {
    console.log('‚úÖ Connect√© √† PostgreSQL');
});

pool.on('error', (err) => {
    console.error('‚ùå Erreur PostgreSQL:', err);
});

module.exports = pool;
```

## üöÄ 6. Processus de D√©ploiement

### D√©ploiement automatique
Render red√©ploie automatiquement √† chaque push sur la branche `main` :

```bash
git add .
git commit -m "Deploy: Mise √† jour de l'application"
git push origin main
```

### V√©rification du d√©ploiement
1. **Logs** : Consultez les logs dans Render Dashboard
2. **Sant√©** : V√©rifiez que le service est "Live"
3. **Base de donn√©es** : Testez la connexion dans l'onglet "Connect"

## üîç 7. Surveillance et Maintenance

### Logs de l'application
```bash
# Dans Render Dashboard ‚Üí Votre service ‚Üí Logs
# Ou via Render CLI
render logs -s samabled-app
```

### Monitoring de la base de donn√©es
- **M√©triques** : CPU, M√©moire, Connexions
- **Backups** : Automatiques sur Render
- **Alertes** : Configurables dans les param√®tres

### Mise √† l'√©chelle
Pour augmenter les performances :
1. **Web Service** : Passer au plan payant pour plus de ressources
2. **Database** : Upgrader vers un plan avec plus de stockage/connexions

## üåç 8. Domaine Personnalis√© (Optionnel)

1. Dans votre service web ‚Üí **Settings** ‚Üí **Custom Domains**
2. Ajoutez votre domaine : `samabled.com`
3. Configurez les DNS selon les instructions Render
4. SSL automatique via Let's Encrypt

## üîß 9. Variables d'Environnement Compl√®tes

```bash
# Base de donn√©es
DATABASE_URL=postgresql://user:password@host:port/database

# S√©curit√©
JWT_SECRET=your_super_secure_jwt_secret_here_32_chars_min
PORT=10000

# APIs externes
OPENAI_API_KEY=sk-your-openai-api-key-here

# Configuration
NODE_ENV=production
CORS_ORIGIN=https://samabled.onrender.com

# Optionnel : Configuration email (pour reset password)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

## üÜò 10. D√©pannage

### Probl√®mes courants

**1. Erreur de connexion √† la base de donn√©es**
```bash
# V√©rifiez DATABASE_URL dans les variables d'environnement
# Format: postgresql://username:password@host:port/database
```

**2. Application ne d√©marre pas**
```bash
# V√©rifiez les logs pour les erreurs
# Assurez-vous que PORT=10000
# V√©rifiez que server.js √©coute sur '0.0.0.0'
```

**3. Erreurs 502/503**
```bash
# L'application met du temps √† d√©marrer (plan gratuit)
# V√©rifiez que le processus √©coute sur le bon port
# Consultez les logs pour les erreurs de d√©marrage
```

### Commandes utiles

```bash
# Red√©ployer manuellement
git commit --allow-empty -m "Redeploy"
git push origin main

# V√©rifier les variables d'environnement
# Dans Render Dashboard ‚Üí Service ‚Üí Environment

# Tester la base de donn√©es
# Utilisez l'External Database URL avec un client PostgreSQL
```

## üìû Support

- **Documentation Render** : [docs.render.com](https://docs.render.com)
- **Support Render** : Via le dashboard ou Discord
- **Repository** : [Issues GitHub](https://github.com/Zalint/samabled/issues)

---

## üéâ F√©licitations !

Votre application SamaBled est maintenant d√©ploy√©e sur Render ! 

**URL de votre application** : `https://samabled-app.onrender.com`

N'oubliez pas de tester toutes les fonctionnalit√©s apr√®s le d√©ploiement ! üöÄ 